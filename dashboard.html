<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - ConnectorHub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #27ae60;
      --error: #e74c3c;
      --gray: #7f8c8d;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7fa; color: #2c3e50; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header {
      background-color: white; padding: 15px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;
      position: sticky; top: 0; z-index: 100;
    }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; align-items: center; }
    .logo i { color: var(--primary); font-size: 1.8rem; margin-right: 10px; }
    .logo h1 { font-size: 1.8rem; font-weight: 700; background: linear-gradient(to right, var(--primary), #1effbc); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .user-actions a { margin-left: 15px; color: var(--secondary); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 5px; }
    .user-actions a:hover { color: var(--primary); }
    .profile-container { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
    .profile-sidebar {
      background: white; border-radius: 10px; padding: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 90px;
    }
    .profile-pic { width: 150px; height: 150px; border-radius: 50%; background-color: #eee; margin: 0 auto 20px; overflow: hidden; position: relative; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; }
    .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
    .profile-name { text-align: center; margin-bottom: 30px; }
    .profile-name h2 { margin-bottom: 5px; font-size: 1.5rem; color: var(--dark); }
    .profile-name p { color: var(--gray); font-size: 1rem; }
    .profile-content { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 600px; }
    .section-title { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .section-title h2 { font-size: 1.8rem; color: var(--dark); }
    .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .alert-success { background: rgba(39, 174, 96, 0.1); border: 1px solid var(--success); color: var(--success); }
    .alert-error { background: rgba(231, 76, 60, 0.1); border: 1px solid var(--error); color: var(--error); }
    .hidden { display: none; }
    .field { margin-bottom: 20px; }
    .label { font-weight: 600; color: var(--primary); margin-bottom: 5px; display: block; }
    .value { color: var(--dark); font-size: 1.1rem; }
    @media (max-width: 992px) {
      .profile-container { grid-template-columns: 1fr; }
      .profile-sidebar { position: relative; top: 0; }
    }
    @media (max-width: 576px) {
      .header-content { flex-direction: column; gap: 15px; }
      .user-actions { width: 100%; display: flex; justify-content: center; }
      .profile-content { padding: 20px; }
      .profile-sidebar { padding: 20px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <div class="logo">
        <i class="fas fa-hands-helping"></i>
        <h1>ConnectorHub</h1>
      </div>
      <div class="user-actions">
        <a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </div>
  </header>
  <div class="container">
    <div class="profile-container">
      <div class="profile-sidebar">
        <div class="profile-pic" id="profile-pic-box">
          <img id="profile-image" src="" alt="Profile Picture">
        </div>
        <div class="profile-name">
          <h2 id="display-name">Loading...</h2>
          <p id="user-email">user@example.com</p>
        </div>
      </div>
      <div class="profile-content">
        <div class="section-title">
          <h2>Profile Information</h2>
        </div>
        <div id="profile-message" class="alert hidden"></div>
        <div id="profile-info">
          <!-- Profile fields will appear here -->
        </div>
      </div>
    </div>
  </div>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script>
    // Firebase config (use your own project's values)
    const firebaseConfig = {
      apiKey: "AIzaSyAAqMkxlTrgvPmJ5WdyeCwMWgcx2lW51WA",
      authDomain: "connectorhubsignup.firebaseapp.com",
      projectId: "connectorhubsignup",
      storageBucket: "connectorhubsignup.appspot.com",
      messagingSenderId: "1069616706414",
      appId: "1:1069616706414:web:f0843d21127b358390077f",
      measurementId: "G-EEYDQT70JG"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Your deployed Apps Script web app URL:
    const API_URL = "https://script.google.com/macros/s/AKfycbxi8sClgWJASORXaMxKsc0RSpfU78Aouc-7hz-mZHeC07nu5C4sQb0tEABqiaUsMpuYVw/exec";

    // DOM
    const displayName = document.getElementById('display-name');
    const userEmail = document.getElementById('user-email');
    const profileImage = document.getElementById('profile-image');
    const profileInfo = document.getElementById('profile-info');
    const logoutBtn = document.getElementById('logout');

    // Auth state
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'business.html';
      } else {
        displayName.textContent = user.displayName || 'No Name Set';
        userEmail.textContent = user.email;
        loadProfileFromSheet(user.email);
      }
    });

    // Fetch and render profile
    async function loadProfileFromSheet(email) {
      profileInfo.innerHTML = "Loading profile data from Google Sheet...";
      try {
        const res = await fetch(`${API_URL}?email=${encodeURIComponent(email)}`);
        const data = await res.json();

        if (!data.found) {
          profileInfo.innerHTML = "<p><strong>Email not found in Google Sheet.</strong></p>";
          profileImage.src = "https://ui-avatars.com/api/?name=No+Image&background=eee&color=888&size=150";
          return;
        }

        // Set profile image (from google drive link if present)
        if (data["Profile Picture"] && data["Profile Picture"].includes("drive.google.com")) {
          const fileIdMatch = data["Profile Picture"].match(/[-\w]{25,}/);
          if (fileIdMatch) {
            const fileId = fileIdMatch[0];
            profileImage.src = `https://drive.google.com/uc?export=view&id=${fileId}`;
          }
        } else {
          // fallback: show avatar with initials
          let initials = (data["Full Name"] || email || "User").split(' ').map(n => n[0]).join('');
          profileImage.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=3498db&color=fff&size=150`;
        }

        // Display all fields (except Profile Picture)
        let html = "";
        for (const key in data) {
          if (key === "found" || key === "Profile Picture" || key === "Timestamp") continue;
          let value = data[key];

          // Format date fields
          if (key.toLowerCase().includes("date")) {
            const d = new Date(value);
            value = !isNaN(d.getTime()) ? d.toLocaleDateString('en-GB') : value;
          }

          // Format time fields
          if (key.toLowerCase().includes("from") || key.toLowerCase().includes("to")) {
            // Try to parse as time, fallback to original
            const t = value && value.match && value.match(/^([01]\d|2[0-3]):([0-5]\d)/) ? value : null;
            value = t ? value : value;
          }

          // Hyperlink URLs
          if (typeof value === "string" && value.includes("http")) {
            const parts = value.split(/, ?/);
            value = parts.map(v =>
              v.startsWith("http") ? `<a href="${v}" target="_blank">${v}</a>` : v
            ).join(", ");
          }

          html += `
            <div class="field">
              <div class="label">${key}:</div>
              <div class="value">${value || '<span style="color:#aaa;">Not provided</span>'}</div>
            </div>`;
        }
        profileInfo.innerHTML = html;
      } catch (err) {
        profileInfo.innerHTML = "<p>Error fetching profile. Please try again.</p>";
        profileImage.src = "https://ui-avatars.com/api/?name=Error&background=eee&color=888&size=150";
      }
    }

    // Logout
    logoutBtn.addEventListener('click', e => {
      e.preventDefault();
      auth.signOut().then(() => {
        window.location.href = 'business.html';
      });
    });
  </script>
</body>
</html>
