<script>
  const sheetId = '1wODunklSmhWV2WzgqgwDAjhJ26WmF0B_qNfteYmdUfU';
  const url = `https://opensheet.elk.sh/${sheetId}/CleanData`;

  let dataRows = [];

  const countrySel = document.getElementById('country');
  const provSel = document.getElementById('province');
  const distSel = document.getElementById('district');
  const tehSel = document.getElementById('tehsil');
  const searchBtn = document.getElementById('search');
  const teamsList = document.getElementById('teams-list');
  const loader = document.getElementById('loader');

  function enableAllDropdowns() {
    countrySel.disabled = false;
    provSel.disabled = false;
    distSel.disabled = false;
    tehSel.disabled = false;
    searchBtn.disabled = false;
  }

  fetch(url)
    .then(response => response.json())
    .then(rows => {
      dataRows = rows.map(row => {
        // Trim all values in each row
        const trimmedRow = {};
        for (let key in row) {
          trimmedRow[key] = row[key]?.trim();
        }
        return trimmedRow;
      });

      const countries = getUnique(dataRows, "Player_Country");
      populateDropdown(countrySel, countries);
      loader.style.display = 'none';
      enableAllDropdowns();
    })
    .catch(error => {
      console.error("Error fetching sheet data:", error);
      loader.innerHTML = "<p style='color:red;'>Failed to load data. Please refresh.</p>";
    });

  function getUnique(arr, col) {
    return [...new Set(arr.map(item => item[col]).filter(Boolean))].sort();
  }

  function populateDropdown(selectEl, items) {
    selectEl.innerHTML = '<option value="">-- Select --</option>';
    items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      selectEl.appendChild(opt);
    });
  }

  function clearDropdown(selectEl) {
    selectEl.innerHTML = '<option value="">-- Select --</option>';
  }

  countrySel.addEventListener('change', () => {
    const filtered = dataRows.filter(row =>
      row["Player_Country"] === countrySel.value
    );
    populateDropdown(provSel, getUnique(filtered, "Player_Province/State"));
    clearDropdown(distSel);
    clearDropdown(tehSel);
  });

  provSel.addEventListener('change', () => {
    const filtered = dataRows.filter(row =>
      row["Player_Country"] === countrySel.value &&
      row["Player_Province/State"] === provSel.value
    );
    populateDropdown(distSel, getUnique(filtered, "Player_District"));
    clearDropdown(tehSel);
  });

  distSel.addEventListener('change', () => {
    const filtered = dataRows.filter(row =>
      row["Player_Country"] === countrySel.value &&
      row["Player_Province/State"] === provSel.value &&
      row["Player_District"] === distSel.value
    );
    populateDropdown(tehSel, getUnique(filtered, "Player_Tehsil"));
  });

  searchBtn.addEventListener('click', () => {
    const filtered = dataRows.filter(row =>
      row["Player_Country"] === countrySel.value &&
      row["Player_Province/State"] === provSel.value &&
      row["Player_District"] === distSel.value &&
      row["Player_Tehsil"] === tehSel.value &&
      row["Player_Sport_Category"]?.toLowerCase() === "football"
    );
    const teamNames = getUnique(filtered, "Player_Team_Name");
    teamsList.innerHTML = teamNames.length
      ? teamNames.map(name => `<li>${name}</li>`).join('')
      : "<li>No teams found.</li>";
  });
</script>
